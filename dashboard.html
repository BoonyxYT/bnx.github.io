<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beaxly - Music Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- EMAILJS INTEGRATION -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- ColorThief para extraer colores de imágenes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script src="auth.js"></script>
    <style>
        #youtube-player {
            border-radius: 10px;
        }
        .debug-info {
            display: none;
        }
        .player-placeholder {
            display: block;
        }
        .player-active .player-placeholder {
            display: none;
        }
        .tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
        }
        .tag.active {
            background: #0ea5e9;
            color: white;
        }
        .tag-filter {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-filter:hover {
            transform: translateY(-2px);
        }
        
        /* Theme classes */
        .theme-original {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #6d28d9 100%);
        }
        .theme-red {
            background: linear-gradient(135deg, #7f1d1d 0%, #9d174d 50%, #be185d 100%);
        }
        .theme-green {
            background: linear-gradient(135deg, #14532d 0%, #0f766e 50%, #0d9488 100%);
        }
        .theme-purple {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%);
        }
        .theme-black {
            background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%);
        }
        
        /* Tema Dinámico */
        .theme-dynamic {
            background: linear-gradient(135deg, var(--dynamic-primary) 0%, var(--dynamic-secondary) 50%, var(--dynamic-accent) 100%);
            transition: background 1.5s ease;
        }
        
        .theme-original .accent-color {
            color: #22d3ee;
        }
        .theme-red .accent-color {
            color: #f87171;
        }
        .theme-green .accent-color {
            color: #34d399;
        }
        .theme-purple .accent-color {
            color: #c084fc;
        }
        .theme-black .accent-color {
            color: #9ca3af;
        }
        .theme-dynamic .accent-color {
            color: var(--dynamic-accent);
        }
        
        .theme-original .accent-bg {
            background-color: rgba(34, 211, 238, 0.2);
        }
        .theme-red .accent-bg {
            background-color: rgba(248, 113, 113, 0.2);
        }
        .theme-green .accent-bg {
            background-color: rgba(52, 211, 153, 0.2);
        }
        .theme-purple .accent-bg {
            background-color: rgba(192, 132, 252, 0.2);
        }
        .theme-black .accent-bg {
            background-color: rgba(156, 163, 175, 0.2);
        }
        .theme-dynamic .accent-bg {
            background-color: rgba(var(--dynamic-accent-rgb), 0.2);
        }
        
        .theme-original .accent-btn {
            background-color: #22d3ee;
        }
        .theme-red .accent-btn {
            background-color: #f87171;
        }
        .theme-green .accent-btn {
            background-color: #34d399;
        }
        .theme-purple .accent-btn {
            background-color: #c084fc;
        }
        .theme-black .accent-btn {
            background-color: #9ca3af;
        }
        .theme-dynamic .accent-btn {
            background-color: var(--dynamic-accent);
        }
        
        .theme-original .accent-btn:hover {
            background-color: #06b6d4;
        }
        .theme-red .accent-btn:hover {
            background-color: #ef4444;
        }
        .theme-green .accent-btn:hover {
            background-color: #10b981;
        }
        .theme-purple .accent-btn:hover {
            background-color: #a855f7;
        }
        .theme-black .accent-btn:hover {
            background-color: #6b7280;
        }
        .theme-dynamic .accent-btn:hover {
            background-color: var(--dynamic-accent-dark);
        }
        
        /* Theme selector styles */
        .theme-selector {
            position: relative;
            display: inline-block;
        }
        
        .theme-options {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            padding: 8px 0;
            margin-top: 5px;
        }
        
        .theme-options.show {
            display: block;
        }
        
        .theme-option {
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .theme-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .theme-color {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .theme-original .theme-color {
            background: linear-gradient(135deg, #1e3a8a, #6d28d9);
        }
        .theme-red .theme-color {
            background: linear-gradient(135deg, #7f1d1d, #be185d);
        }
        .theme-green .theme-color {
            background: linear-gradient(135deg, #14532d, #0d9488);
        }
        .theme-purple .theme-color {
            background: linear-gradient(135deg, #581c87, #a855f7);
        }
        .theme-black .theme-color {
            background: linear-gradient(135deg, #111827, #374151);
        }
        .theme-dynamic .theme-color {
            background: linear-gradient(135deg, #1e3a8a, #22d3ee);
        }
        
        /* Cursor light effect */
        .cursor-light {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 9999;
            mix-blend-mode: overlay;
            transition: transform 0.1s ease-out;
        }
        
        /* Logo animation */
        .logo {
            background: linear-gradient(90deg, #22d3ee, #a855f7, #34d399);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% 100%;
            animation: gradientMove 3s ease infinite;
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Playlist Generator Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
        
        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-option {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .filter-option.selected {
            background: #22d3ee;
            color: white;
        }
        
        .song-count-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .song-count-input {
            width: 60px;
            padding: 8px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            text-align: center;
        }
        
        /* Particle background */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        
        /* Filter visibility */
        .filter-list {
            display: none;
        }
        
        .filter-list.active {
            display: flex;
        }
        
        .filter-toggle.active {
            background: #22d3ee;
            color: white;
        }
        
        /* Updated styles for filters */
        .filter-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-toggle-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .filter-toggle {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
        }
        
        .filter-toggle.active {
            background: #22d3ee;
            color: white;
        }
        
        .filter-tag {
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .filter-tag.active {
            background: #22d3ee;
            color: white;
        }
        
        /* Efectos de onda de sonido para el tema dinámico */
        .sound-wave {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(var(--dynamic-accent-rgb), 0.3) 0%, rgba(var(--dynamic-accent-rgb), 0) 70%);
            transform: scale(0);
            animation: soundWave 1.5s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes soundWave {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* Elementos que reaccionan al ritmo */
        .beat-element {
            transition: transform 0.3s ease;
        }
        
        .beat-active {
            transform: scale(1.05);
        }
        
        /* Partículas de audio */
        .audio-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background-color: var(--dynamic-accent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
        }
        
        /* Fondo con overlay para mejorar legibilidad en tema dinámico */
        .dynamic-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }
        
        /* Animación de pulsación para el reproductor */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .player-pulse {
            animation: pulse 0.5s ease-in-out infinite;
        }
    </style>

    <script>
        // Sample data for testing the application
        let playlists = JSON.parse(localStorage.getItem('musicPlaylists')) || [
            {
                id: "1",
                name: "Relaxing Music",
                songs: [
                    { id: "1", title: "Meditation Music", url: "https://www.youtube.com/watch?v=NTpbbQUBbuo&list=RDQMsHhx03c4Dwk&index=3", videoId: "z2U8HW9HW9XYpE" },
                    { id: "2", title: "Nature Sounds", url: "https://www.youtube.com/watch?v=859u6uiZdds&list=RDQMsHhx03c4Dwk&index=1", videoId: "q76bMs-NwRk" }
                ]
            },
            {
                id: "2",
                name: "Summer Hits",
                songs: [
                    { id: "3", title: "Summer Song 2023", url: "https://www.youtube.com/watch?v=JGwWNGJdvx8", videoId: "JGwWNGJdvx8" }
                ]
            }
        ];

        // Discover songs (shared across all users) - Updated with tags, artists and years
        let discoverSongs = JSON.parse(localStorage.getItem('discoverSongs')) || [
            { 
                id: "d1", 
                title: "Big Sleep", 
                url: "https://www.youtube.com/watch?v=-wTr3bTbVO8", 
                videoId: "ZQWyrYh_Zq8",
                tags: ["Pop", "R&B", "Chill"],
                artist: "The Weeknd",
                year: 2023
            },
            { 
                id: "d2", 
                title: "SOLEAO", 
                url: "https://www.youtube.com/watch?v=JgqsAvvwZAQ", 
                videoId: "JgqsAvvwZAQ",
                tags: ["Reggaeton", "Latin"],
                artist: "Myke Towers & Quevedo",
                year: 2023
            },
            { 
                id: "d3", 
                title: "The Wild Project #344", 
                url: "https://www.youtube.com/watch?v=HjEVxPCmlVM", 
                videoId: "HjEVxPCmlVM",
                tags: ["Podcast", "Talk", "Interview"],
                artist: "The Wild Project",
                year: 2023
            },
            { 
                id: "d4", 
                title: "Believer", 
                url: "https://www.youtube.com/watch?v=7wtfhZwyrcc", 
                videoId: "7wtfhZwyrcc",
                tags: ["Rock", "Pop Rock", "Alternative"],
                artist: "Imagine Dragons",
                year: 2017
            },
            { 
                id: "d5", 
                title: "Titi Me Preguntó", 
                url: "https://www.youtube.com/watch?v=saGYMhApaH8", 
                videoId: "saGYMhApaH8",
                tags: ["Reggaeton", "Latin", "Urban"],
                artist: "Bad Bunny",
                year: 2022
            },
            { 
                id: "d6", 
                title: "Viva La Vida", 
                url: "https://www.youtube.com/watch?v=dvgZkm1xWPE", 
                videoId: "dvgZkm1xWPE",
                tags: ["Rock", "Alternative", "Pop"],
                artist: "Coldplay",
                year: 2008
            },
            { 
                id: "d7", 
                title: "Blinding Lights", 
                url: "https://www.youtube.com/watch?v=4NRXx6U8ABQ", 
                videoId: "4NRXx6U8ABQ",
                tags: ["Pop", "Synthwave", "80s"],
                artist: "The Weeknd",
                year: 2019
            },
            { 
                id: "d8", 
                title: "Shape of You", 
                url: "https://www.youtube.com/watch?v=JGwWNGJdvx8", 
                videoId: "JGwWNGJdvx8",
                tags: ["Pop", "Dance"],
                artist: "Ed Sheeran",
                year: 2017
            },
            { 
                id: "d9", 
                title: "Despacito", 
                url: "https://www.youtube.com/watch?v=kJQP7kiw5Fk", 
                videoId: "kJQP7kiw5Fk",
                tags: ["Reggaeton", "Latin", "Pop"],
                artist: "Luis Fonsi ft. Daddy Yankee",
                year: 2017
            },
            { 
                id: "d10", 
                title: "Uptown Funk", 
                url: "https://www.youtube.com/watch?v=OPf0YbXqDm0", 
                videoId: "OPf0YbXqDm0",
                tags: ["Funk", "Pop", "R&B"],
                artist: "Mark Ronson ft. Bruno Mars",
                year: 2014
            }
        ];

        // User authentication state
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        
        // YouTube Player variables
        let player; // variable global del reproductor
        let currentPlaylistIndex = null;
        let currentSongIndex = 0;

        // Tag filter variables
        let activeTag = null;
        let activeArtist = null;
        let activeFilterType = null; // 'genres', 'artists', or null
        
        // Theme management
        let currentTheme = localStorage.getItem('currentTheme') || 'original';

        // Playlist Generator variables
        let selectedGenres = [];
        let selectedEras = [];
        let songCount = 10;

        // Cache for rendered filters to improve performance
        let tagFiltersRendered = false;
        let artistFiltersRendered = false;

        // Variables para el tema dinámico
        let dynamicColors = {
            primary: '#1e3a8a',
            secondary: '#3730a3',
            accent: '#22d3ee',
            accentDark: '#06b6d4'
        };
        
        let dynamicColorsRGB = {
            accent: '34, 211, 238'
        };
        
        // Elementos que reaccionarán al ritmo
        let beatElements = [];
        
        // Variables para simular el análisis de audio
        let audioContext;
        let analyser;
        let audioData;
        let isPlaying = false;
        let beatInterval;
        let waveInterval;

        // Debug function
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
                debugInfo.style.display = 'block';
            }
        }

        // Save to localStorage
        function savePlaylists() {
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
        }

        function saveDiscoverSongs() {
            localStorage.setItem('discoverSongs', JSON.stringify(discoverSongs));
        }

        function saveUser() {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        // Extract YouTube video ID from URL
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Generate unique ID for songs and playlists
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Apply theme to the page
        function applyTheme(theme) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.classList.add(`theme-${theme}`);
            currentTheme = theme;
            localStorage.setItem('currentTheme', theme);
            
            // Si se selecciona el tema dinámico, inicializarlo
            if (theme === 'dynamic') {
                initDynamicTheme();
            } else {
                // Si se cambia a otro tema, detener efectos
                stopBeatEffects();
            }
        }

        // Toggle theme selector
        function toggleThemeSelector() {
            const themeOptions = document.getElementById('theme-options');
            themeOptions.classList.toggle('show');
        }

        // Scroll to discover section
        function scrollToDiscover() {
            document.querySelector('.discover-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Initialize cursor light effect
        function initCursorLight() {
            const cursorLight = document.createElement('div');
            cursorLight.className = 'cursor-light';
            document.body.appendChild(cursorLight);
            
            document.addEventListener('mousemove', (e) => {
                cursorLight.style.left = e.clientX + 'px';
                cursorLight.style.top = e.clientY + 'px';
            });
            
            // Hide cursor light when not moving for a while
            let timeout;
            document.addEventListener('mousemove', () => {
                cursorLight.style.opacity = '1';
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    cursorLight.style.opacity = '0';
                }, 1000);
            });
        }

        // Inicializar el tema dinámico
        function initDynamicTheme() {
            // Aplicar colores iniciales
            applyDynamicColors();
            
            // Inicializar simulación de audio (en un caso real, esto se conectaría al audio real)
            initAudioSimulation();
            
            // Recolectar elementos que reaccionarán al ritmo
            collectBeatElements();
            
            console.log("Tema dinámico inicializado");
        }
        
        // Aplicar colores dinámicos al CSS
        function applyDynamicColors() {
            const root = document.documentElement;
            root.style.setProperty('--dynamic-primary', dynamicColors.primary);
            root.style.setProperty('--dynamic-secondary', dynamicColors.secondary);
            root.style.setProperty('--dynamic-accent', dynamicColors.accent);
            root.style.setProperty('--dynamic-accent-dark', dynamicColors.accentDark);
            root.style.setProperty('--dynamic-accent-rgb', dynamicColorsRGB.accent);
        }
        
        // Extraer colores dominantes de una imagen
        function extractColorsFromThumbnail(thumbnailUrl) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = thumbnailUrl;
            
            img.onload = function() {
                const colorThief = new ColorThief();
                try {
                    const palette = colorThief.getPalette(img, 3);
                    
                    if (palette && palette.length >= 3) {
                        // Convertir RGB a HEX
                        dynamicColors.primary = rgbToHex(palette[0][0], palette[0][1], palette[0][2]);
                        dynamicColors.secondary = rgbToHex(palette[1][0], palette[1][1], palette[1][2]);
                        dynamicColors.accent = rgbToHex(palette[2][0], palette[2][1], palette[2][2]);
                        dynamicColors.accentDark = adjustBrightness(dynamicColors.accent, -30);
                        
                        dynamicColorsRGB.accent = `${palette[2][0]}, ${palette[2][1]}, ${palette[2][2]}`;
                        
                        applyDynamicColors();
                        console.log("Colores extraídos y aplicados:", dynamicColors);
                    }
                } catch (e) {
                    console.log("Error extrayendo colores:", e);
                }
            };
            
            img.onerror = function() {
                console.log("Error cargando la miniatura para extraer colores");
            };
        }
        
        // Convertir RGB a HEX
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Ajustar el brillo de un color HEX
        function adjustBrightness(hex, percent) {
            // Convertir HEX a RGB
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            
            // Ajustar brillo
            r = Math.max(0, Math.min(255, r + (r * percent) / 100));
            g = Math.max(0, Math.min(255, g + (g * percent) / 100));
            b = Math.max(0, Math.min(255, b + (b * percent) / 100));
            
            // Convertir de nuevo a HEX
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        // Inicializar simulación de análisis de audio
        function initAudioSimulation() {
            // En un caso real, esto se conectaría al audio del reproductor de YouTube
            // Por ahora, simulamos el análisis con datos aleatorios
            
            // Crear un contexto de audio simulado
            audioContext = {
                // Propiedades simuladas
            };
            
            analyser = {
                // Propiedades simuladas
            };
            
            audioData = new Uint8Array(128);
            
            console.log("Simulación de audio inicializada");
        }
        
        // Recolectar elementos que reaccionarán al ritmo
        function collectBeatElements() {
            beatElements = [
                ...document.querySelectorAll('.playlist-card'),
                ...document.querySelectorAll('.discover-song-card'),
                ...document.querySelectorAll('.accent-btn'),
                ...document.querySelectorAll('.player-section')
            ];
            
            console.log(`Elementos que reaccionan al ritmo: ${beatElements.length}`);
        }
        
        // Iniciar efectos de ritmo
        function startBeatEffects() {
            if (isPlaying) return;
            
            isPlaying = true;
            
            // Efecto de pulsación para elementos
            beatInterval = setInterval(() => {
                // Simular datos de audio (en un caso real, usaríamos analyser.getByteFrequencyData(audioData))
                for (let i = 0; i < audioData.length; i++) {
                    audioData[i] = Math.random() * 255;
                }
                
                // Calcular un valor de "beat" basado en los datos simulados
                const beatValue = audioData[10] / 255;
                
                // Aplicar efecto a elementos
                beatElements.forEach(el => {
                    if (beatValue > 0.7) {
                        el.classList.add('beat-active');
                        setTimeout(() => {
                            el.classList.remove('beat-active');
                        }, 150);
                    }
                });
                
                // Crear ondas de sonido ocasionales
                if (Math.random() > 0.7) {
                    createSoundWave();
                }
                
                // Crear partículas de audio ocasionales
                if (Math.random() > 0.9) {
                    createAudioParticles();
                }
            }, 100);
            
            // Efecto de pulsación para el reproductor
            const playerContainer = document.getElementById('player-container');
            if (playerContainer) {
                playerContainer.classList.add('player-pulse');
            }
            
            console.log("Efectos de ritmo iniciados");
        }
        
        // Detener efectos de ritmo
        function stopBeatEffects() {
            if (!isPlaying) return;
            
            isPlaying = false;
            clearInterval(beatInterval);
            
            // Detener pulsación del reproductor
            const playerContainer = document.getElementById('player-container');
            if (playerContainer) {
                playerContainer.classList.remove('player-pulse');
            }
            
            console.log("Efectos de ritmo detenidos");
        }
        
        // Crear una onda de sonido visual
        function createSoundWave() {
            const wave = document.createElement('div');
            wave.className = 'sound-wave';
            
            // Posicionar la onda cerca del reproductor
            const player = document.getElementById('youtube-player');
            if (player && player.style.display !== 'none') {
                const rect = player.getBoundingClientRect();
                wave.style.left = (rect.left + rect.width / 2) + 'px';
                wave.style.top = (rect.top + rect.height / 2) + 'px';
            } else {
                // Si no hay reproductor visible, usar el centro de la pantalla
                wave.style.left = '50%';
                wave.style.top = '50%';
            }
            
            wave.style.width = '50px';
            wave.style.height = '50px';
            
            document.body.appendChild(wave);
            
            // Eliminar la onda después de la animación
            setTimeout(() => {
                if (wave.parentNode) {
                    wave.parentNode.removeChild(wave);
                }
            }, 1500);
        }
        
        // Crear partículas de audio
        function createAudioParticles() {
            const particleCount = 5 + Math.floor(Math.random() * 10);
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'audio-particle';
                
                // Posicionar partículas cerca del reproductor
                const player = document.getElementById('youtube-player');
                if (player && player.style.display !== 'none') {
                    const rect = player.getBoundingClientRect();
                    particle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                    particle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                } else {
                    // Si no hay reproductor visible, dispersar por la pantalla
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                }
                
                document.body.appendChild(particle);
                
                // Animar partícula
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                const duration = 1000 + Math.random() * 1000;
                
                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { 
                        transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0)`, 
                        opacity: 0 
                    }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.215, 0.610, 0.355, 1)'
                });
                
                // Eliminar partícula después de la animación
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, duration);
            }
        }

        // Render all playlists
        function renderPlaylists() {
            const container = document.getElementById('playlists-container');
            container.innerHTML = '';

            if (playlists.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center p-10 opacity-70">
                        <i class="fas fa-music text-5xl mb-4 opacity-50"></i>
                        <p>You don't have any playlists yet.</p>
                        <p>Create your first playlist by adding a song!</p>
                    </div>
                `;
                return;
            }

            playlists.forEach((playlist, playlistIndex) => {
                const playlistElement = document.createElement('div');
                playlistElement.className = 'playlist-card beat-element bg-white/10 rounded-xl p-5 mb-6 shadow-lg transition-transform hover:-translate-y-1';
                
                let songsHtml = '';
                
                if (playlist.songs.length === 0) {
                    songsHtml = `
                        <div class="empty-state text-center p-10 opacity-70">
                            <i class="fas fa-plus-circle text-5xl mb-4 opacity-50"></i>
                            <p>This playlist is empty</p>
                            <p>Add songs using the "Add to this playlist" button</p>
                        </div>
                    `;
                } else {
                    playlist.songs.forEach((song, songIndex) => {
                        songsHtml += `
                            <div class="song-item flex justify-between items-center p-4 bg-white/5 rounded-lg mb-3 transition-colors hover:bg-white/10">
                                <div class="song-info flex items-center gap-4 flex-1">
                                    <div class="song-thumbnail w-24 h-18 rounded-lg bg-gray-700 flex items-center justify-center overflow-hidden flex-shrink-0">
                                        <img src="https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg" alt="Thumbnail" class="w-full h-full object-cover">
                                    </div>
                                    <div class="song-details flex-1">
                                        <div class="song-title font-medium text-lg mb-1">${song.title}</div>
                                        <div class="song-url text-sm opacity-70 break-all">${song.url}</div>
                                    </div>
                                </div>
                                <div class="song-actions flex gap-2.5">
                                    <button class="btn-play accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-green-600" 
                                            data-playlist="${playlistIndex}" data-song="${songIndex}">
                                        <i class="fas fa-play mr-1"></i> Play
                                    </button>
                                    <button class="bg-red-500 text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-red-600" 
                                            data-playlist="${playlistIndex}" data-song="${songIndex}">
                                        <i class="fas fa-trash mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }

                // Add song button for this playlist
                songsHtml += `
                    <div class="song-item flex justify-between items-center p-4 accent-bg rounded-lg">
                        <div class="song-info flex items-center gap-4 flex-1">
                            <div class="song-thumbnail w-24 h-18 rounded-lg bg-cyan-400/50 flex items-center justify-center">
                                <i class="fas fa-plus text-xl"></i>
                            </div>
                            <div class="song-details flex-1">
                                <div class="song-title font-medium text-lg">Add a new song to this playlist</div>
                                <div class="song-url text-sm opacity-70">Click the button to add a YouTube video</div>
                            </div>
                        </div>
                        <div class="song-actions">
                            <button class="add-to-playlist-btn accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-green-600" 
                                    data-playlist="${playlistIndex}">
                                <i class="fas fa-plus-circle mr-1"></i> Add to this Playlist
                            </button>
                        </div>
                    </div>
                `;

                playlistElement.innerHTML = `
                    <div class="playlist-header flex justify-between items-center mb-5 pb-4 border-b border-white/20">
                        <h3 class="playlist-title text-2xl accent-color">${playlist.name}</h3>
                        <div class="playlist-actions flex gap-2.5">
                            <button class="delete-playlist bg-red-500 text-white px-4 py-2 rounded cursor-pointer transition-colors hover:bg-red-600" 
                                    data-index="${playlistIndex}">
                                <i class="fas fa-trash mr-1"></i> Delete Playlist
                            </button>
                        </div>
                    </div>
                    ${songsHtml}
                `;

                container.appendChild(playlistElement);
            });

            // Add event listeners
            document.querySelectorAll('.btn-play').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-playlist');
                    const songIndex = this.getAttribute('data-song');
                    playSong(playlistIndex, songIndex);
                });
            });

            document.querySelectorAll('.bg-red-500').forEach(button => {
                if (!button.classList.contains('delete-playlist')) {
                    button.addEventListener('click', function() {
                        const playlistIndex = this.getAttribute('data-playlist');
                        const songIndex = this.getAttribute('data-song');
                        removeSong(playlistIndex, songIndex);
                    });
                }
            });

            document.querySelectorAll('.delete-playlist').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-index');
                    deletePlaylist(playlistIndex);
                });
            });

            document.querySelectorAll('.add-to-playlist-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-playlist');
                    document.getElementById('existing-playlists').value = playlistIndex;
                    document.getElementById('playlist-name').value = playlists[playlistIndex].name;
                    document.getElementById('youtube-url').focus();
                });
            });

            // Update the existing playlists dropdown
            updatePlaylistsDropdown();
            
            // Actualizar elementos que reaccionan al ritmo
            if (currentTheme === 'dynamic') {
                collectBeatElements();
            }
        }

        // Get all unique tags from discover songs
        function getAllTags() {
            const allTags = new Set();
            discoverSongs.forEach(song => {
                if (song.tags) {
                    song.tags.forEach(tag => allTags.add(tag));
                }
            });
            return Array.from(allTags);
        }

        // Get all unique artists from discover songs
        function getAllArtists() {
            const allArtists = new Set();
            discoverSongs.forEach(song => {
                if (song.artist) {
                    allArtists.add(song.artist);
                }
            });
            return Array.from(allArtists);
        }

        // Get all unique years from discover songs
        function getAllYears() {
            const allYears = new Set();
            discoverSongs.forEach(song => {
                if (song.year) {
                    allYears.add(song.year);
                }
            });
            return Array.from(allYears).sort((a, b) => b - a); // Sort descending
        }

        // Get all unique eras from discover songs
        function getAllEras() {
            const eras = new Set();
            discoverSongs.forEach(song => {
                if (song.year) {
                    if (song.year >= 2020) {
                        eras.add("2020s");
                    } else if (song.year >= 2010) {
                        eras.add("2010s");
                    } else if (song.year >= 2000) {
                        eras.add("2000s");
                    } else if (song.year >= 1990) {
                        eras.add("1990s");
                    } else {
                        eras.add("Classic");
                    }
                }
            });
            return Array.from(eras);
        }

        // Render tag filters (only once)
        function renderTagFilters() {
            if (tagFiltersRendered) return;
            
            const container = document.getElementById('tag-filters');
            const allTags = getAllTags();
            
            let tagsHtml = '';
            
            allTags.forEach(tag => {
                tagsHtml += `
                    <button class="filter-tag ${activeTag === tag ? 'active' : ''}" 
                            data-tag="${tag}">
                        ${tag}
                    </button>
                `;
            });
            
            container.innerHTML = tagsHtml;
            tagFiltersRendered = true;
            
            // Use event delegation for better performance
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-tag')) {
                    const tag = e.target.getAttribute('data-tag');
                    setActiveTag(tag);
                }
            });
        }

        // Render artist filters (only once)
        function renderArtistFilters() {
            if (artistFiltersRendered) return;
            
            const container = document.getElementById('artist-filters');
            const allArtists = getAllArtists();
            
            let artistsHtml = '';
            
            allArtists.forEach(artist => {
                artistsHtml += `
                    <button class="filter-tag ${activeArtist === artist ? 'active' : ''}" 
                            data-artist="${artist}">
                        ${artist}
                    </button>
                `;
            });
            
            container.innerHTML = artistsHtml;
            artistFiltersRendered = true;
            
            // Use event delegation for better performance
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-tag')) {
                    const artist = e.target.getAttribute('data-artist');
                    setActiveArtist(artist);
                }
            });
        }

        // Set active tag and re-render discover songs
        function setActiveTag(tag) {
            activeTag = tag;
            activeArtist = null; // Reset artist filter when using tag filter
            
            // Update UI state
            updateFilterButtons();
            renderDiscoverSongs();
        }

        // Set active artist and re-render discover songs
        function setActiveArtist(artist) {
            activeArtist = artist;
            activeTag = null; // Reset tag filter when using artist filter
            
            // Update UI state
            updateFilterButtons();
            renderDiscoverSongs();
        }

        // Update filter button states
        function updateFilterButtons() {
            // Update tag filters
            document.querySelectorAll('#tag-filters .filter-tag').forEach(button => {
                const tag = button.getAttribute('data-tag');
                if (activeTag === tag) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            // Update artist filters
            document.querySelectorAll('#artist-filters .filter-tag').forEach(button => {
                const artist = button.getAttribute('data-artist');
                if (activeArtist === artist) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Toggle filter visibility
        function toggleFilterType(type) {
            // Hide all filter lists first
            document.getElementById('tag-filters').classList.remove('active');
            document.getElementById('artist-filters').classList.remove('active');
            
            // Remove active class from all toggle buttons
            document.getElementById('genres-btn').classList.remove('active');
            document.getElementById('artists-btn').classList.remove('active');
            
            // If clicking the same filter type that's already active, deactivate it
            if (activeFilterType === type) {
                activeFilterType = null;
            } else {
                // Otherwise, activate the selected type
                activeFilterType = type;
                document.getElementById(`${type}-filters`).classList.add('active');
                document.getElementById(`${type}-btn`).classList.add('active');
            }
        }

        // Reset all filters
        function resetFilters() {
            activeTag = null;
            activeArtist = null;
            activeFilterType = null;
            
            // Hide all filter lists
            document.getElementById('tag-filters').classList.remove('active');
            document.getElementById('artist-filters').classList.remove('active');
            
            // Remove active class from all toggle buttons
            document.getElementById('genres-btn').classList.remove('active');
            document.getElementById('artists-btn').classList.remove('active');
            
            updateFilterButtons();
            renderDiscoverSongs();
        }

        // Render discover songs with filtering
        function renderDiscoverSongs() {
            const container = document.getElementById('discover-songs-container');
            container.innerHTML = '';

            // Filter songs based on active tag or active artist
            let filteredSongs = discoverSongs;
            
            if (activeTag) {
                filteredSongs = filteredSongs.filter(song => song.tags && song.tags.includes(activeTag));
            }
            
            if (activeArtist) {
                filteredSongs = filteredSongs.filter(song => song.artist === activeArtist);
            }

            if (filteredSongs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center p-10 opacity-70 col-span-full">
                        <i class="fas fa-compass text-5xl mb-4 opacity-50"></i>
                        <p>No songs found for the selected filter.</p>
                        <p>Try selecting a different filter or view all songs.</p>
                    </div>
                `;
                return;
            }

            filteredSongs.forEach((song, index) => {
                // Find the original index in discoverSongs array
                const originalIndex = discoverSongs.findIndex(s => s.id === song.id);
                
                const songElement = document.createElement('div');
                songElement.className = 'discover-song-card beat-element bg-white/5 rounded-lg p-4 transition-transform hover:-translate-y-1 hover:bg-white/10';
                
                // Generate tags HTML
                let tagsHtml = '';
                if (song.tags && song.tags.length > 0) {
                    song.tags.forEach(tag => {
                        tagsHtml += `<span class="tag">${tag}</span>`;
                    });
                }
                
                songElement.innerHTML = `
                    <div class="discover-song-thumbnail w-full h-36 rounded-lg mb-2.5 overflow-hidden">
                        <img src="https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg" alt="Thumbnail" class="w-full h-full object-cover">
                    </div>
                    <div class="song-details">
                        <div class="song-title font-medium text-lg mb-1">${song.title}</div>
                        <div class="song-artist text-sm opacity-80 mb-1">${song.artist || 'Unknown Artist'}</div>
                        <div class="song-year text-sm opacity-70 mb-2">${song.year || 'Unknown Year'}</div>
                        <div class="song-tags my-2">${tagsHtml}</div>
                        <div class="song-url text-xs opacity-70 truncate">${song.url}</div>
                    </div>
                    <div class="discover-song-actions flex gap-2.5 mt-2.5">
                        <button class="discover-play accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm flex-1 transition-colors hover:bg-green-600" 
                                data-index="${originalIndex}">
                            <i class="fas fa-play mr-1"></i> Play
                        </button>
                        <button class="discover-add accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm flex-1 transition-colors hover:bg-green-600" 
                                data-index="${originalIndex}">
                            <i class="fas fa-plus mr-1"></i> Add to My List
                        </button>
                    </div>
                `;

                container.appendChild(songElement);
            });

            // Add event listeners for discover songs
            document.querySelectorAll('.discover-play').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    playDiscoverSong(index);
                });
            });

            document.querySelectorAll('.discover-add').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    addDiscoverSongToPlaylist(index);
                });
            });
            
            // Actualizar elementos que reaccionan al ritmo
            if (currentTheme === 'dynamic') {
                collectBeatElements();
            }
        }

        // Update the existing playlists dropdown
        function updatePlaylistsDropdown() {
            const dropdown = document.getElementById('existing-playlists');
            
            // Clear existing options except the first one
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Add current playlists
            playlists.forEach((playlist, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = playlist.name;
                dropdown.appendChild(option);
            });
        }

        // Modificar la función playSong para integrar el tema dinámico
        function playSong(playlistIndex, songIndex) {
            currentPlaylistIndex = playlistIndex;
            currentSongIndex = parseInt(songIndex);

            const song = playlists[playlistIndex].songs[songIndex];
            
            // Obtener miniatura y extraer colores
            const thumbnailUrl = `https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg`;
            if (currentTheme === 'dynamic') {
                extractColorsFromThumbnail(thumbnailUrl);
                startBeatEffects();
            }
            
            // Hide placeholder and show player container
            document.getElementById('player-placeholder').style.display = 'none';
            document.getElementById('youtube-player').style.display = 'block';
            document.getElementById('player-container').classList.add('player-active');

            if (!player) {
                player = new YT.Player('youtube-player', {
                    height: '384',
                    width: '100%',
                    videoId: song.videoId,
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                player.loadVideoById(song.videoId);
            }
        }

        // Función que detecta cuando termina el video
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                // Detener efectos de ritmo cuando termine el video
                if (currentTheme === 'dynamic') {
                    stopBeatEffects();
                }
                
                const playlist = playlists[currentPlaylistIndex];
                currentSongIndex++;

                // Si terminamos la lista, reiniciamos desde el primer video
                if (currentSongIndex >= playlist.songs.length) {
                    currentSongIndex = 0;
                }

                const nextSong = playlist.songs[currentSongIndex];
                player.loadVideoById(nextSong.videoId);
                
                // Reiniciar efectos para la siguiente canción
                if (currentTheme === 'dynamic') {
                    setTimeout(() => {
                        startBeatEffects();
                    }, 500);
                }
            } else if (event.data === YT.PlayerState.PAUSED) {
                // Detener efectos cuando se pause
                if (currentTheme === 'dynamic') {
                    stopBeatEffects();
                }
            } else if (event.data === YT.PlayerState.PLAYING) {
                // Reiniciar efectos cuando se reanude
                if (currentTheme === 'dynamic') {
                    startBeatEffects();
                }
            }
        }

        // Modificar la función playDiscoverSong para integrar el tema dinámico
        function playDiscoverSong(index) {
            const song = discoverSongs[index];
            
            // Obtener miniatura y extraer colores
            const thumbnailUrl = `https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg`;
            if (currentTheme === 'dynamic') {
                extractColorsFromThumbnail(thumbnailUrl);
                startBeatEffects();
            }
            
            // Hide placeholder and show player container
            document.getElementById('player-placeholder').style.display = 'none';
            document.getElementById('youtube-player').style.display = 'block';
            document.getElementById('player-container').classList.add('player-active');

            if (!player) {
                player = new YT.Player('youtube-player', {
                    height: '384',
                    width: '100%',
                    videoId: song.videoId,
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                player.loadVideoById(song.videoId);
            }
        }

        // Add a discover song to user's playlist
        function addDiscoverSongToPlaylist(index) {
            const song = discoverSongs[index];
            
            // Check if user has a "My Discoveries" playlist, if not create one
            let playlistIndex = playlists.findIndex(p => p.name === "My Discoveries");
            if (playlistIndex === -1) {
                playlists.push({
                    id: generateId(),
                    name: "My Discoveries",
                    songs: []
                });
                playlistIndex = playlists.length - 1;
            }
            
            // Add the song to the playlist
            playlists[playlistIndex].songs.push({
                id: generateId(),
                title: song.title,
                url: song.url,
                videoId: song.videoId
            });
            
            // Save and update the view
            savePlaylists();
            renderPlaylists();
            alert(`"${song.title}" has been added to your "My Discoveries" playlist!`);
        }

        // Remove a song
        function removeSong(playlistIndex, songIndex) {
            if (confirm('Are you sure you want to remove this song?')) {
                playlists[playlistIndex].songs.splice(songIndex, 1);
                savePlaylists();
                renderPlaylists();
            }
        }

        // Delete a playlist
        function deletePlaylist(playlistIndex) {
            if (confirm('Are you sure you want to delete this playlist?')) {
                playlists.splice(playlistIndex, 1);
                savePlaylists();
                renderPlaylists();
            }
        }

        // Add a new song to user's playlist
        function addSong() {
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            const songTitle = document.getElementById('song-title').value.trim();
            const playlistName = document.getElementById('playlist-name').value.trim();
            
            if (!youtubeUrl) {
                alert('Please enter a YouTube URL');
                return;
            }
            
            const videoId = extractVideoId(youtubeUrl);
            if (!videoId) {
                alert('The YouTube URL is not valid');
                return;
            }
            
            if (!playlistName) {
                alert('Please enter a playlist name');
                return;
            }
            
            // Find if playlist already exists
            let playlistIndex = playlists.findIndex(p => p.name === playlistName);
            
            // If it doesn't exist, create a new playlist
            if (playlistIndex === -1) {
                playlists.push({
                    id: generateId(),
                    name: playlistName,
                    songs: []
                });
                playlistIndex = playlists.length - 1;
            }
            
            // Add the song to the playlist
            const finalTitle = songTitle || `Song ${playlists[playlistIndex].songs.length + 1}`;
            playlists[playlistIndex].songs.push({
                id: generateId(),
                title: finalTitle,
                url: youtubeUrl,
                videoId: videoId
            });
            
            // Save and update the view
            savePlaylists();
            renderPlaylists();
            
            // Clear input fields
            document.getElementById('youtube-url').value = '';
            document.getElementById('song-title').value = '';
        }

        // Add a song to discover section (admin only)
        function addSongToDiscover() {
            const youtubeUrl = document.getElementById('discover-youtube-url').value.trim();
            const songTitle = document.getElementById('discover-song-title').value.trim();
            const songArtist = document.getElementById('discover-song-artist').value.trim();
            const songYear = document.getElementById('discover-song-year').value.trim();
            
            if (!youtubeUrl) {
                alert('Please enter a YouTube URL');
                return;
            }
            
            const videoId = extractVideoId(youtubeUrl);
            if (!videoId) {
                alert('The YouTube URL is not valid');
                return;
            }
            
            if (!songTitle) {
                alert('Please enter a song title');
                return;
            }
            
            // Add the song to discover section
            discoverSongs.push({
                id: generateId(),
                title: songTitle,
                url: youtubeUrl,
                videoId: videoId,
                artist: songArtist || 'Unknown Artist',
                year: songYear || new Date().getFullYear(),
                addedBy: currentUser.email,
                tags: [] // Admin can add tags manually in the code for now
            });
            
            // Save and update the view
            saveDiscoverSongs();
            renderDiscoverSongs();
            renderTagFilters();
            renderArtistFilters();
            
            // Clear input fields
            document.getElementById('discover-youtube-url').value = '';
            document.getElementById('discover-song-title').value = '';
            document.getElementById('discover-song-artist').value = '';
            document.getElementById('discover-song-year').value = '';
            
            alert('Song added to Discover section!');
        }

        // Quick add to existing playlist
        function quickAdd() {
            const playlistIndex = document.getElementById('existing-playlists').value;
            if (playlistIndex === "") {
                alert('Please select a playlist');
                return;
            }
            
            document.getElementById('playlist-name').value = playlists[playlistIndex].name;
            addSong();
        }

        function logout() {
            currentUser = null;
            saveUser();
            // Redirect to login page
            window.location.href = 'index.html';
        }

        function updateUIForUser() {
            if (currentUser) {
                // User is signed in
                document.getElementById('user-email').textContent = currentUser.email;
                
                if (currentUser.isAdmin) {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                    document.getElementById('admin-controls').style.display = 'block';
                } else {
                    document.getElementById('admin-badge').style.display = 'none';
                    document.getElementById('admin-controls').style.display = 'none';
                }
                
                // Render user-specific content
                renderPlaylists();
                renderDiscoverSongs();
                renderTagFilters();
                renderArtistFilters();
            } else {
                // User is not signed in, redirect to login
                window.location.href = 'index.html';
            }
        }

        // Playlist Generator Functions
        function openPlaylistGenerator() {
            document.getElementById('playlist-generator-modal').style.display = 'flex';
            populateGeneratorFilters();
        }

        function closePlaylistGenerator() {
            document.getElementById('playlist-generator-modal').style.display = 'none';
            // Reset selections
            selectedGenres = [];
            selectedEras = [];
            songCount = 10;
            updateFilterSelections();
        }

        function populateGeneratorFilters() {
            const genresContainer = document.getElementById('genre-filters');
            const erasContainer = document.getElementById('era-filters');
            
            // Populate genres
            const allGenres = getAllTags();
            genresContainer.innerHTML = '';
            allGenres.forEach(genre => {
                genresContainer.innerHTML += `
                    <div class="filter-option ${selectedGenres.includes(genre) ? 'selected' : ''}" 
                         data-value="${genre}" onclick="toggleFilter('genres', '${genre}')">
                        ${genre}
                    </div>
                `;
            });
            
            // Populate eras
            const allEras = getAllEras();
            erasContainer.innerHTML = '';
            allEras.forEach(era => {
                erasContainer.innerHTML += `
                    <div class="filter-option ${selectedEras.includes(era) ? 'selected' : ''}" 
                         data-value="${era}" onclick="toggleFilter('eras', '${era}')">
                        ${era}
                    </div>
                `;
            });
            
            // Set song count
            document.getElementById('song-count').value = songCount;
        }

        function toggleFilter(type, value) {
            let array;
            switch(type) {
                case 'genres':
                    array = selectedGenres;
                    break;
                case 'eras':
                    array = selectedEras;
                    break;
            }
            
            const index = array.indexOf(value);
            if (index === -1) {
                array.push(value);
            } else {
                array.splice(index, 1);
            }
            
            updateFilterSelections();
        }

        function updateFilterSelections() {
            // Update UI to reflect current selections
            document.querySelectorAll('#genre-filters .filter-option').forEach(option => {
                const value = option.getAttribute('data-value');
                if (selectedGenres.includes(value)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            document.querySelectorAll('#era-filters .filter-option').forEach(option => {
                const value = option.getAttribute('data-value');
                if (selectedEras.includes(value)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
            
            // Update song count
            songCount = parseInt(document.getElementById('song-count').value) || 10;
        }

        function generatePlaylist() {
            // Filter songs based on selections
            let filteredSongs = [...discoverSongs];
            
            // Filter by genres
            if (selectedGenres.length > 0) {
                filteredSongs = filteredSongs.filter(song => 
                    song.tags && song.tags.some(tag => selectedGenres.includes(tag))
                );
            }
            
            // Filter by eras
            if (selectedEras.length > 0) {
                filteredSongs = filteredSongs.filter(song => {
                    if (!song.year) return false;
                    
                    let era = "";
                    if (song.year >= 2020) {
                        era = "2020s";
                    } else if (song.year >= 2010) {
                        era = "2010s";
                    } else if (song.year >= 2000) {
                        era = "2000s";
                    } else if (song.year >= 1990) {
                        era = "1990s";
                    } else {
                        era = "Classic";
                    }
                    
                    return selectedEras.includes(era);
                });
            }
            
            // Limit to requested number of songs
            if (filteredSongs.length > songCount) {
                // Shuffle and take first n songs
                filteredSongs = filteredSongs
                    .sort(() => 0.5 - Math.random())
                    .slice(0, songCount);
            }
            
            if (filteredSongs.length === 0) {
                alert("No songs match your criteria. Please try different filters.");
                return;
            }
            
            // Create playlist name based on filters
            let playlistName = "Generated Playlist";
            if (selectedGenres.length > 0) {
                playlistName += ` - ${selectedGenres.join(', ')}`;
            }
            if (selectedEras.length > 0) {
                playlistName += ` (${selectedEras.join(', ')})`;
            }
            
            // Create the playlist
            playlists.push({
                id: generateId(),
                name: playlistName,
                songs: filteredSongs.map(song => ({
                    id: generateId(),
                    title: song.title,
                    url: song.url,
                    videoId: song.videoId
                }))
            });
            
            // Save and update the view
            savePlaylists();
            renderPlaylists();
            
            // Close the modal
            closePlaylistGenerator();
            
            alert(`Playlist "${playlistName}" with ${filteredSongs.length} songs has been created!`);
        }

        // Initialize particles background
        function initParticles() {
            // Simple particle system implementation
            const canvas = document.createElement('canvas');
            canvas.id = 'particles-js';
            document.body.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            let particlesArray = [];
            
            // Set canvas size
            function setCanvasSize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            setCanvasSize();
            window.addEventListener('resize', setCanvasSize);
            
            // Particle class
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 0.5;
                    this.speedX = Math.random() * 0.5 - 0.25;
                    this.speedY = Math.random() * 0.5 - 0.25;
                    this.color = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
                }
                
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    
                    // Bounce off edges
                    if (this.x > canvas.width || this.x < 0) {
                        this.speedX = -this.speedX;
                    }
                    if (this.y > canvas.height || this.y < 0) {
                        this.speedY = -this.speedY;
                    }
                }
                
                draw() {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Create particles
            function init() {
                particlesArray = [];
                const numberOfParticles = (canvas.width * canvas.height) / 9000;
                for (let i = 0; i < numberOfParticles; i++) {
                    particlesArray.push(new Particle());
                }
            }
            
            // Animation loop
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].update();
                    particlesArray[i].draw();
                }
                requestAnimationFrame(animate);
            }
            
            init();
            animate();
            
            // Reinitialize on resize
            window.addEventListener('resize', function() {
                setCanvasSize();
                init();
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Application initialized');
            
            // Apply saved theme
            applyTheme(currentTheme);
            
            // Initialize cursor light effect
            initCursorLight();
            
            // Initialize particles background
            initParticles();
            
            // Check if user is already signed in
            updateUIForUser();
            
            // Add song button event
            document.getElementById('add-song-btn').addEventListener('click', addSong);
            
            // Quick add button event
            document.getElementById('quick-add-btn').addEventListener('click', quickAdd);
            
            // Add to discover button event
            document.getElementById('add-to-discover-btn').addEventListener('click', addSongToDiscover);
            
            // Allow pressing Enter in the URL field to add a song
            document.getElementById('youtube-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSong();
                }
            });
            
            // Logout event
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Discover button event
            document.getElementById('discover-btn').addEventListener('click', scrollToDiscover);
            
            // Theme selector events
            document.getElementById('theme-toggle-btn').addEventListener('click', toggleThemeSelector);
            
            // Theme option events
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    applyTheme(theme);
                    document.getElementById('theme-options').classList.remove('show');
                });
            });
            
            // Close theme selector when clicking outside
            document.addEventListener('click', function(event) {
                const themeSelector = document.querySelector('.theme-selector');
                if (!themeSelector.contains(event.target)) {
                    document.getElementById('theme-options').classList.remove('show');
                }
            });
            
            // Playlist generator events
            document.getElementById('generate-playlist-btn').addEventListener('click', openPlaylistGenerator);
            document.getElementById('close-generator-btn').addEventListener('click', closePlaylistGenerator);
            document.getElementById('generate-btn').addEventListener('click', generatePlaylist);
            document.getElementById('song-count').addEventListener('change', function() {
                songCount = parseInt(this.value) || 10;
            });
            
            // Filter toggle events
            document.getElementById('genres-btn').addEventListener('click', function() {
                toggleFilterType('tag');
            });
            
            document.getElementById('artists-btn').addEventListener('click', function() {
                toggleFilterType('artist');
            });
            
            // Show all button event
            document.getElementById('show-all-btn').addEventListener('click', resetFilters);
            
            // Close modal when clicking outside
            document.getElementById('playlist-generator-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePlaylistGenerator();
                }
            });
            
            debugLog('All event listeners attached');
        });
    </script>
    
</head>
<body class="theme-original text-white min-h-screen pb-12">
    <!-- Overlay para el tema dinámico -->
    <div class="dynamic-overlay" style="display: none;"></div>
    
    <header class="bg-black/70 py-6 mb-8 shadow-lg">
        <div class="container mx-auto px-5 flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-4xl font-bold mb-3 logo">
                    <i class="fas fa-music mr-2"></i> Beaxly - Music Manager
                </h1>
                <p class="text-xl opacity-90">Create and manage your YouTube playlists easily</p>
            </div>
            <div class="flex gap-4">
                <button id="discover-btn" class="accent-btn text-white px-6 py-3 rounded-lg cursor-pointer transition-all hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-compass mr-2"></i> Discover
                </button>
                <div class="theme-selector">
                    <button id="theme-toggle-btn" class="bg-white/20 text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-white/30">
                        <i class="fas fa-palette mr-2"></i> Themes
                    </button>
                    <div id="theme-options" class="theme-options">
                        <div class="theme-option" data-theme="original">
                            <span class="theme-color"></span> Original
                        </div>
                        <div class="theme-option" data-theme="red">
                            <span class="theme-color"></span> Red
                        </div>
                        <div class="theme-option" data-theme="green">
                            <span class="theme-color"></span> Green
                        </div>
                        <div class="theme-option" data-theme="purple">
                            <span class="theme-color"></span> Purple
                        </div>
                        <div class="theme-option" data-theme="black">
                            <span class="theme-color"></span> Black
                        </div>
                        <div class="theme-option" data-theme="dynamic">
                            <span class="theme-color"></span> Dynamic
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-5">
        <!-- User Info Section -->
        <div id="user-info" class="flex justify-between items-center mb-5 p-4 bg-white/10 rounded-xl">
            <div class="flex items-center gap-2.5">
                <span id="user-email"></span>
                <span id="admin-badge" class="hidden bg-orange-500 text-white px-2.5 py-1.5 rounded-full text-xs font-bold">
                    ADMIN
                </span>
            </div>
            <button id="logout-btn" 
                    class="bg-red-500 text-white border-0 px-3 py-2 rounded cursor-pointer transition-colors hover:bg-red-600">
                Logout
            </button>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <div class="flex flex-col lg:flex-row gap-8">
                <section class="flex-1 min-w-[350px] bg-white/10 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">Add New Song</h2>
                    <div class="mb-5">
                        <label for="youtube-url" class="block mb-2 font-medium">
                            <i class="fab fa-youtube mr-2"></i> YouTube URL:
                        </label>
                        <input type="text" id="youtube-url" placeholder="Paste YouTube URL here..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <div class="mb-5">
                        <label for="song-title" class="block mb-2 font-medium">
                            <i class="fas fa-heading mr-2"></i> Song Title (optional):
                        </label>
                        <input type="text" id="song-title" placeholder="Enter a custom title..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <div class="mb-5">
                        <label for="playlist-name" class="block mb-2 font-medium">
                            <i class="fas fa-list mr-2"></i> Add to Playlist:
                        </label>
                        <input type="text" id="playlist-name" placeholder="Enter playlist name..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <button id="add-song-btn" 
                            class="w-full inline-block accent-btn text-white px-6 py-3.5 rounded-lg cursor-pointer text-base font-medium text-center transition-all hover:-translate-y-1 hover:shadow-lg">
                        <i class="fas fa-plus-circle mr-2"></i> Add to Playlist
                    </button>
                    
                    <div class="quick-add-section bg-white/5 rounded-lg p-5 mt-5">
                        <h3 class="text-lg font-semibold mb-4">Quick Add to Existing Playlist</h3>
                        <div class="playlist-selector flex gap-2.5 mb-4 items-center">
                            <select id="existing-playlists" 
                                    class="flex-1 px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                                <option value="">Select a playlist...</option>
                            </select>
                            <button id="quick-add-btn" 
                                    class="accent-btn text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>
                        </div>
                    </div>
                    
                    <div class="player-section mt-8 bg-white/10 rounded-xl p-5 shadow-lg">
                        <h3 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">
                            <i class="fas fa-play-circle mr-2"></i> Player
                        </h3>
                        <div id="player-container">
                            <div id="youtube-player" style="display: none;"></div>
                            <div id="player-placeholder" class="player-placeholder text-center p-10 bg-black/30 rounded-lg">
                                <i class="fas fa-play-circle text-5xl mb-4 opacity-50"></i>
                                <p>Select a song to play it here</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="flex-2 min-w-[350px]">
                    <h2 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">My Playlists</h2>
                    <div id="playlists-container">
                        <!-- Playlists will be generated here dynamically -->
                    </div>
                </section>
            </div>

            <!-- Discover Section -->
            <section class="discover-section bg-white/10 rounded-xl p-6 mt-8 shadow-lg">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-2xl font-bold accent-color">
                        <i class="fas fa-compass mr-2"></i> Discover
                    </h2>
                    <button id="generate-playlist-btn" class="accent-btn text-white px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-green-600">
                        <i class="fas fa-magic mr-2"></i> Generate Playlist
                    </button>
                </div>
                
                <!-- Tag Filters -->
                <div class="filter-container mb-6">
                    <h3 class="text-lg font-semibold mb-3 accent-color">Filter by:</h3>
                    <div class="filter-toggle-buttons">
                        <button id="show-all-btn" class="filter-toggle accent-btn">
                            <i class="fas fa-eye mr-1"></i> Show All
                        </button>
                        <button id="genres-btn" class="filter-toggle">
                            <i class="fas fa-tags mr-1"></i> Genres
                        </button>
                        <button id="artists-btn" class="filter-toggle">
                            <i class="fas fa-users mr-1"></i> Artists
                        </button>
                    </div>
                    <div id="tag-filters" class="filter-list">
                        <!-- Tag filters will be generated here dynamically -->
                    </div>
                    <div id="artist-filters" class="filter-list">
                        <!-- Artist filters will be generated here dynamically -->
                    </div>
                </div>
                
                <!-- Admin Controls (only visible to admin) -->
                <div id="admin-controls" class="admin-controls bg-orange-500/20 rounded-lg p-5 mb-5 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-orange-400">Admin Controls</h3>
                    <div class="admin-form grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="discover-youtube-url" placeholder="YouTube URL for Discover section" 
                               class="px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                        <input type="text" id="discover-song-title" placeholder="Song title" 
                               class="px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                        <input type="text" id="discover-song-artist" placeholder="Artist" 
                               class="px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                        <input type="text" id="discover-song-year" placeholder="Year" 
                               class="px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                        <button id="add-to-discover-btn" 
                                class="bg-orange-500 text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-orange-600 md:col-span-2">
                            <i class="fas fa-plus mr-1"></i> Add to Discover
                        </button>
                    </div>
                </div>
                
                <div id="discover-songs-container" class="discover-songs grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Discover songs will be generated here dynamically -->
                </div>
            </section>
        </div>
    </div>

    <!-- Playlist Generator Modal -->
    <div id="playlist-generator-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold accent-color">Generate Playlist</h3>
                <button id="close-generator-btn" class="text-white text-xl">&times;</button>
            </div>
            
            <div class="filter-section">
                <span class="filter-title">Select Genres:</span>
                <div id="genre-filters" class="filter-options">
                    <!-- Genre options will be populated here -->
                </div>
            </div>
            
            <div class="filter-section">
                <span class="filter-title">Select Eras:</span>
                <div id="era-filters" class="filter-options">
                    <!-- Era options will be populated here -->
                </div>
            </div>
            
            <div class="song-count-selector">
                <span class="filter-title">Number of Songs:</span>
                <input type="number" id="song-count" class="song-count-input" min="1" max="50" value="10">
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button id="close-generator-btn" class="bg-gray-500 text-white px-4 py-2 rounded cursor-pointer transition-colors hover:bg-gray-600">
                    Cancel
                </button>
                <button id="generate-btn" class="accent-btn text-white px-4 py-2 rounded cursor-pointer transition-colors hover:bg-green-600">
                    Generate Playlist
                </button>
            </div>
        </div>
    </div>

    <!-- YouTube API Script -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // Esta función es requerida por la API pero no necesita contenido aquí
        function onYouTubeIframeAPIReady() {
            // El reproductor se inicializará cuando se llame a playSong por primera vez
        }
    </script>

</body>
</html>


