<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Manager - Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- EMAILJS INTEGRATION -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="auth.js"></script>
    <style>
        #youtube-player {
            border-radius: 10px;
        }
        .debug-info {
            display: none;
        }
        .player-placeholder {
            display: block;
        }
        .player-active .player-placeholder {
            display: none;
        }
        .tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
        }
        .tag.active {
            background: #0ea5e9;
            color: white;
        }
        .tag-filter {
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-filter:hover {
            transform: translateY(-2px);
        }
        
        /* Theme classes */
        .theme-original {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #6d28d9 100%);
        }
        .theme-red {
            background: linear-gradient(135deg, #7f1d1d 0%, #9d174d 50%, #be185d 100%);
        }
        .theme-green {
            background: linear-gradient(135deg, #14532d 0%, #0f766e 50%, #0d9488 100%);
        }
        .theme-purple {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #a855f7 100%);
        }
        .theme-black {
            background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%);
        }
        
        /* Theme-specific accent colors */
        .theme-original .accent-color {
            color: #22d3ee;
        }
        .theme-red .accent-color {
            color: #f87171;
        }
        .theme-green .accent-color {
            color: #34d399;
        }
        .theme-purple .accent-color {
            color: #c084fc;
        }
        .theme-black .accent-color {
            color: #9ca3af;
        }
        
        .theme-original .accent-bg {
            background-color: rgba(34, 211, 238, 0.2);
        }
        .theme-red .accent-bg {
            background-color: rgba(248, 113, 113, 0.2);
        }
        .theme-green .accent-bg {
            background-color: rgba(52, 211, 153, 0.2);
        }
        .theme-purple .accent-bg {
            background-color: rgba(192, 132, 252, 0.2);
        }
        .theme-black .accent-bg {
            background-color: rgba(156, 163, 175, 0.2);
        }
        
        .theme-original .accent-btn {
            background-color: #22d3ee;
        }
        .theme-red .accent-btn {
            background-color: #f87171;
        }
        .theme-green .accent-btn {
            background-color: #34d399;
        }
        .theme-purple .accent-btn {
            background-color: #c084fc;
        }
        .theme-black .accent-btn {
            background-color: #9ca3af;
        }
        
        .theme-original .accent-btn:hover {
            background-color: #06b6d4;
        }
        .theme-red .accent-btn:hover {
            background-color: #ef4444;
        }
        .theme-green .accent-btn:hover {
            background-color: #10b981;
        }
        .theme-purple .accent-btn:hover {
            background-color: #a855f7;
        }
        .theme-black .accent-btn:hover {
            background-color: #6b7280;
        }
        
        /* Theme selector styles */
        .theme-selector {
            position: relative;
            display: inline-block;
        }
        
        .theme-options {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            padding: 8px 0;
            margin-top: 5px;
        }
        
        .theme-options.show {
            display: block;
        }
        
        .theme-option {
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .theme-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .theme-color {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .theme-original .theme-color {
            background: linear-gradient(135deg, #1e3a8a, #6d28d9);
        }
        .theme-red .theme-color {
            background: linear-gradient(135deg, #7f1d1d, #be185d);
        }
        .theme-green .theme-color {
            background: linear-gradient(135deg, #14532d, #0d9488);
        }
        .theme-purple .theme-color {
            background: linear-gradient(135deg, #581c87, #a855f7);
        }
        .theme-black .theme-color {
            background: linear-gradient(135deg, #111827, #374151);
        }
    </style>

    <script>
        // Sample data for testing the application
        let playlists = JSON.parse(localStorage.getItem('musicPlaylists')) || [
            {
                id: "1",
                name: "Relaxing Music",
                songs: [
                    { id: "1", title: "Meditation Music", url: "https://www.youtube.com/watch?v=NTpbbQUBbuo&list=RDQMsHhx03c4Dwk&index=3", videoId: "z2U8HW9XYpE" },
                    { id: "2", title: "Nature Sounds", url: "https://www.youtube.com/watch?v=859u6uiZdds&list=RDQMsHhx03c4Dwk&index=1", videoId: "q76bMs-NwRk" }
                ]
            },
            {
                id: "2",
                name: "Summer Hits",
                songs: [
                    { id: "3", title: "Summer Song 2023", url: "https://www.youtube.com/watch?v=JGwWNGJdvx8", videoId: "JGwWNGJdvx8" }
                ]
            }
        ];

        // Discover songs (shared across all users) - Updated with tags
        let discoverSongs = JSON.parse(localStorage.getItem('discoverSongs')) || [
            { 
                id: "d1", 
                title: "The Weeknd - Big Sleep", 
                url: "https://www.youtube.com/watch?v=-wTr3bTbVO8", 
                videoId: "-wTr3bTbVO8",
                tags: ["Pop", "R&B", "Chill"]
            },
            { 
                id: "d2", 
                title: "Myke Towers & Quevedo - SOLEAO", 
                url: "https://www.youtube.com/watch?v=JgqsAvvwZAQ", 
                videoId: "JgqsAvvwZAQ",
                tags: ["Reggaeton", "Latin"]
            },
            { 
                id: "d3", 
                title: "The Wild Project #344", 
                url: "https://www.youtube.com/watch?v=HjEVxPCmlVM", 
                videoId: "HjEVxPCmlVM",
                tags: ["Podcast", "Talk", "Interview"]
            },
            { 
                id: "d4", 
                title: "Imagine Dragons - Believer", 
                url: "https://www.youtube.com/watch?v=7wtfhZwyrcc", 
                videoId: "7wtfhZwyrcc",
                tags: ["Rock", "Pop Rock", "Alternative"]
            },
            { 
                id: "d5", 
                title: "Bad Bunny - Titi Me Preguntó", 
                url: "https://www.youtube.com/watch?v=saGYMhApaH8", 
                videoId: "saGYMhApaH8",
                tags: ["Reggaeton", "Latin", "Urban"]
            },
            { 
                id: "d6", 
                title: "Coldplay - Viva La Vida", 
                url: "https://www.youtube.com/watch?v=dvgZkm1xWPE", 
                videoId: "dvgZkm1xWPE",
                tags: ["Rock", "Alternative", "Pop"]
            }
        ];

        // User authentication state
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        
        // YouTube Player variables
        let player; // variable global del reproductor
        let currentPlaylistIndex = null;
        let currentSongIndex = 0;

        // Tag filter variables
        let activeTag = null;
        
        // Theme management
        let currentTheme = localStorage.getItem('currentTheme') || 'original';

        // Debug function
        function debugLog(message) {
            console.log(message);
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
                debugInfo.style.display = 'block';
            }
        }

        // Save to localStorage
        function savePlaylists() {
            localStorage.setItem('musicPlaylists', JSON.stringify(playlists));
        }

        function saveDiscoverSongs() {
            localStorage.setItem('discoverSongs', JSON.stringify(discoverSongs));
        }

        function saveUser() {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        // Extract YouTube video ID from URL
        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // Generate unique ID for songs and playlists
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Apply theme to the page
        function applyTheme(theme) {
            document.body.className = document.body.className.replace(/theme-\w+/g, '');
            document.body.classList.add(`theme-${theme}`);
            currentTheme = theme;
            localStorage.setItem('currentTheme', theme);
        }

        // Toggle theme selector
        function toggleThemeSelector() {
            const themeOptions = document.getElementById('theme-options');
            themeOptions.classList.toggle('show');
        }

        // Scroll to discover section
        function scrollToDiscover() {
            document.querySelector('.discover-section').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Render all playlists
        function renderPlaylists() {
            const container = document.getElementById('playlists-container');
            container.innerHTML = '';

            if (playlists.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center p-10 opacity-70">
                        <i class="fas fa-music text-5xl mb-4 opacity-50"></i>
                        <p>You don't have any playlists yet.</p>
                        <p>Create your first playlist by adding a song!</p>
                    </div>
                `;
                return;
            }

            playlists.forEach((playlist, playlistIndex) => {
                const playlistElement = document.createElement('div');
                playlistElement.className = 'playlist-card bg-white/10 rounded-xl p-5 mb-6 shadow-lg transition-transform hover:-translate-y-1';
                
                let songsHtml = '';
                
                if (playlist.songs.length === 0) {
                    songsHtml = `
                        <div class="empty-state text-center p-10 opacity-70">
                            <i class="fas fa-plus-circle text-5xl mb-4 opacity-50"></i>
                            <p>This playlist is empty</p>
                            <p>Add songs using the "Add to this playlist" button</p>
                        </div>
                    `;
                } else {
                    playlist.songs.forEach((song, songIndex) => {
                        songsHtml += `
                            <div class="song-item flex justify-between items-center p-4 bg-white/5 rounded-lg mb-3 transition-colors hover:bg-white/10">
                                <div class="song-info flex items-center gap-4 flex-1">
                                    <div class="song-thumbnail w-24 h-18 rounded-lg bg-gray-700 flex items-center justify-center overflow-hidden flex-shrink-0">
                                        <img src="https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg" alt="Thumbnail" class="w-full h-full object-cover">
                                    </div>
                                    <div class="song-details flex-1">
                                        <div class="song-title font-medium text-lg mb-1">${song.title}</div>
                                        <div class="song-url text-sm opacity-70 break-all">${song.url}</div>
                                    </div>
                                </div>
                                <div class="song-actions flex gap-2.5">
                                    <button class="btn-play accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-green-600" 
                                            data-playlist="${playlistIndex}" data-song="${songIndex}">
                                        <i class="fas fa-play mr-1"></i> Play
                                    </button>
                                    <button class="bg-red-500 text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-red-600" 
                                            data-playlist="${playlistIndex}" data-song="${songIndex}">
                                        <i class="fas fa-trash mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }

                // Add song button for this playlist
                songsHtml += `
                    <div class="song-item flex justify-between items-center p-4 accent-bg rounded-lg">
                        <div class="song-info flex items-center gap-4 flex-1">
                            <div class="song-thumbnail w-24 h-18 rounded-lg bg-cyan-400/50 flex items-center justify-center">
                                <i class="fas fa-plus text-xl"></i>
                            </div>
                            <div class="song-details flex-1">
                                <div class="song-title font-medium text-lg">Add a new song to this playlist</div>
                                <div class="song-url text-sm opacity-70">Click the button to add a YouTube video</div>
                            </div>
                        </div>
                        <div class="song-actions">
                            <button class="add-to-playlist-btn accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm transition-colors hover:bg-green-600" 
                                    data-playlist="${playlistIndex}">
                                <i class="fas fa-plus-circle mr-1"></i> Add to this Playlist
                            </button>
                        </div>
                    </div>
                `;

                playlistElement.innerHTML = `
                    <div class="playlist-header flex justify-between items-center mb-5 pb-4 border-b border-white/20">
                        <h3 class="playlist-title text-2xl accent-color">${playlist.name}</h3>
                        <div class="playlist-actions flex gap-2.5">
                            <button class="delete-playlist bg-red-500 text-white px-4 py-2 rounded cursor-pointer transition-colors hover:bg-red-600" 
                                    data-index="${playlistIndex}">
                                <i class="fas fa-trash mr-1"></i> Delete Playlist
                            </button>
                        </div>
                    </div>
                    ${songsHtml}
                `;

                container.appendChild(playlistElement);
            });

            // Add event listeners
            document.querySelectorAll('.btn-play').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-playlist');
                    const songIndex = this.getAttribute('data-song');
                    playSong(playlistIndex, songIndex);
                });
            });

            document.querySelectorAll('.bg-red-500').forEach(button => {
                if (!button.classList.contains('delete-playlist')) {
                    button.addEventListener('click', function() {
                        const playlistIndex = this.getAttribute('data-playlist');
                        const songIndex = this.getAttribute('data-song');
                        removeSong(playlistIndex, songIndex);
                    });
                }
            });

            document.querySelectorAll('.delete-playlist').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-index');
                    deletePlaylist(playlistIndex);
                });
            });

            document.querySelectorAll('.add-to-playlist-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const playlistIndex = this.getAttribute('data-playlist');
                    document.getElementById('existing-playlists').value = playlistIndex;
                    document.getElementById('playlist-name').value = playlists[playlistIndex].name;
                    document.getElementById('youtube-url').focus();
                });
            });

            // Update the existing playlists dropdown
            updatePlaylistsDropdown();
        }

        // Get all unique tags from discover songs
        function getAllTags() {
            const allTags = new Set();
            discoverSongs.forEach(song => {
                if (song.tags) {
                    song.tags.forEach(tag => allTags.add(tag));
                }
            });
            return Array.from(allTags);
        }

        // Render tag filters
        function renderTagFilters() {
            const container = document.getElementById('tag-filters');
            const allTags = getAllTags();
            
            let tagsHtml = `
                <button class="tag-filter accent-btn text-white px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-green-600 ${activeTag === null ? 'active' : ''}" 
                        data-tag="all">
                    <i class="fas fa-eye mr-1"></i> Show All
                </button>
            `;
            
            allTags.forEach(tag => {
                tagsHtml += `
                    <button class="tag-filter bg-white/10 text-white px-4 py-2 rounded-lg cursor-pointer transition-colors hover:bg-white/20 ${activeTag === tag ? 'active' : ''}" 
                            data-tag="${tag}">
                        ${tag}
                    </button>
                `;
            });
            
            container.innerHTML = tagsHtml;
            
            // Add event listeners to tag filters
            document.querySelectorAll('.tag-filter').forEach(button => {
                button.addEventListener('click', function() {
                    const tag = this.getAttribute('data-tag');
                    setActiveTag(tag === 'all' ? null : tag);
                });
            });
        }

        // Set active tag and re-render discover songs
        function setActiveTag(tag) {
            activeTag = tag;
            renderTagFilters();
            renderDiscoverSongs();
        }

        // Render discover songs with filtering
        function renderDiscoverSongs() {
            const container = document.getElementById('discover-songs-container');
            container.innerHTML = '';

            // Filter songs based on active tag
            const filteredSongs = activeTag 
                ? discoverSongs.filter(song => song.tags && song.tags.includes(activeTag))
                : discoverSongs;

            if (filteredSongs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center p-10 opacity-70 col-span-full">
                        <i class="fas fa-compass text-5xl mb-4 opacity-50"></i>
                        <p>No songs found for the selected tag.</p>
                        <p>Try selecting a different tag or view all songs.</p>
                    </div>
                `;
                return;
            }

            filteredSongs.forEach((song, index) => {
                // Find the original index in discoverSongs array
                const originalIndex = discoverSongs.findIndex(s => s.id === song.id);
                
                const songElement = document.createElement('div');
                songElement.className = 'discover-song-card bg-white/5 rounded-lg p-4 transition-transform hover:-translate-y-1 hover:bg-white/10';
                
                // Generate tags HTML
                let tagsHtml = '';
                if (song.tags && song.tags.length > 0) {
                    song.tags.forEach(tag => {
                        tagsHtml += `<span class="tag">${tag}</span>`;
                    });
                }
                
                songElement.innerHTML = `
                    <div class="discover-song-thumbnail w-full h-36 rounded-lg mb-2.5 overflow-hidden">
                        <img src="https://img.youtube.com/vi/${song.videoId}/hqdefault.jpg" alt="Thumbnail" class="w-full h-full object-cover">
                    </div>
                    <div class="song-details">
                        <div class="song-title font-medium text-lg">${song.title}</div>
                        <div class="song-tags my-2">${tagsHtml}</div>
                        <div class="song-url text-sm opacity-70">${song.url}</div>
                    </div>
                    <div class="discover-song-actions flex gap-2.5 mt-2.5">
                        <button class="discover-play accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm flex-1 transition-colors hover:bg-green-600" 
                                data-index="${originalIndex}">
                            <i class="fas fa-play mr-1"></i> Play
                        </button>
                        <button class="discover-add accent-btn text-white px-3 py-2 rounded cursor-pointer text-sm flex-1 transition-colors hover:bg-green-600" 
                                data-index="${originalIndex}">
                            <i class="fas fa-plus mr-1"></i> Add to My List
                        </button>
                    </div>
                `;

                container.appendChild(songElement);
            });

            // Add event listeners for discover songs
            document.querySelectorAll('.discover-play').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    playDiscoverSong(index);
                });
            });

            document.querySelectorAll('.discover-add').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    addDiscoverSongToPlaylist(index);
                });
            });
        }

        // Update the existing playlists dropdown
        function updatePlaylistsDropdown() {
            const dropdown = document.getElementById('existing-playlists');
            
            // Clear existing options except the first one
            while (dropdown.options.length > 1) {
                dropdown.remove(1);
            }
            
            // Add current playlists
            playlists.forEach((playlist, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = playlist.name;
                dropdown.appendChild(option);
            });
        }

        // Play a song from playlist
        function playSong(playlistIndex, songIndex) {
            currentPlaylistIndex = playlistIndex;
            currentSongIndex = parseInt(songIndex);

            const song = playlists[playlistIndex].songs[songIndex];
            
            // Hide placeholder and show player container
            document.getElementById('player-placeholder').style.display = 'none';
            document.getElementById('youtube-player').style.display = 'block';
            document.getElementById('player-container').classList.add('player-active');

            if (!player) {
                player = new YT.Player('youtube-player', {
                    height: '384',
                    width: '100%',
                    videoId: song.videoId,
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                player.loadVideoById(song.videoId);
            }
        }

        // Función que detecta cuando termina el video
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                const playlist = playlists[currentPlaylistIndex];
                currentSongIndex++;

                // Si terminamos la lista, reiniciamos desde el primer video
                if (currentSongIndex >= playlist.songs.length) {
                    currentSongIndex = 0;
                }

                const nextSong = playlist.songs[currentSongIndex];
                player.loadVideoById(nextSong.videoId);
            }
        }

        // Play a song from discover section
        function playDiscoverSong(index) {
            const song = discoverSongs[index];
            
            // Hide placeholder and show player container
            document.getElementById('player-placeholder').style.display = 'none';
            document.getElementById('youtube-player').style.display = 'block';
            document.getElementById('player-container').classList.add('player-active');

            if (!player) {
                player = new YT.Player('youtube-player', {
                    height: '384',
                    width: '100%',
                    videoId: song.videoId,
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                player.loadVideoById(song.videoId);
            }
        }

        // Add a discover song to user's playlist
        function addDiscoverSongToPlaylist(index) {
            const song = discoverSongs[index];
            
            // Check if user has a "My Discoveries" playlist, if not create one
            let playlistIndex = playlists.findIndex(p => p.name === "My Discoveries");
            if (playlistIndex === -1) {
                playlists.push({
                    id: generateId(),
                    name: "My Discoveries",
                    songs: []
                });
                playlistIndex = playlists.length - 1;
            }
            
            // Add the song to the playlist
            playlists[playlistIndex].songs.push({
                id: generateId(),
                title: song.title,
                url: song.url,
                videoId: song.videoId
            });
            
            // Save and update the view
            savePlaylists();
            renderPlaylists();
            alert(`"${song.title}" has been added to your "My Discoveries" playlist!`);
        }

        // Remove a song
        function removeSong(playlistIndex, songIndex) {
            if (confirm('Are you sure you want to remove this song?')) {
                playlists[playlistIndex].songs.splice(songIndex, 1);
                savePlaylists();
                renderPlaylists();
            }
        }

        // Delete a playlist
        function deletePlaylist(playlistIndex) {
            if (confirm('Are you sure you want to delete this playlist?')) {
                playlists.splice(playlistIndex, 1);
                savePlaylists();
                renderPlaylists();
            }
        }

        // Add a new song to user's playlist
        function addSong() {
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            const songTitle = document.getElementById('song-title').value.trim();
            const playlistName = document.getElementById('playlist-name').value.trim();
            
            if (!youtubeUrl) {
                alert('Please enter a YouTube URL');
                return;
            }
            
            const videoId = extractVideoId(youtubeUrl);
            if (!videoId) {
                alert('The YouTube URL is not valid');
                return;
            }
            
            if (!playlistName) {
                alert('Please enter a playlist name');
                return;
            }
            
            // Find if playlist already exists
            let playlistIndex = playlists.findIndex(p => p.name === playlistName);
            
            // If it doesn't exist, create a new playlist
            if (playlistIndex === -1) {
                playlists.push({
                    id: generateId(),
                    name: playlistName,
                    songs: []
                });
                playlistIndex = playlists.length - 1;
            }
            
            // Add the song to the playlist
            const finalTitle = songTitle || `Song ${playlists[playlistIndex].songs.length + 1}`;
            playlists[playlistIndex].songs.push({
                id: generateId(),
                title: finalTitle,
                url: youtubeUrl,
                videoId: videoId
            });
            
            // Save and update the view
            savePlaylists();
            renderPlaylists();
            
            // Clear input fields
            document.getElementById('youtube-url').value = '';
            document.getElementById('song-title').value = '';
        }

        // Add a song to discover section (admin only)
        function addSongToDiscover() {
            const youtubeUrl = document.getElementById('discover-youtube-url').value.trim();
            const songTitle = document.getElementById('discover-song-title').value.trim();
            
            if (!youtubeUrl) {
                alert('Please enter a YouTube URL');
                return;
            }
            
            const videoId = extractVideoId(youtubeUrl);
            if (!videoId) {
                alert('The YouTube URL is not valid');
                return;
            }
            
            if (!songTitle) {
                alert('Please enter a song title');
                return;
            }
            
            // Add the song to discover section
            discoverSongs.push({
                id: generateId(),
                title: songTitle,
                url: youtubeUrl,
                videoId: videoId,
                addedBy: currentUser.email,
                tags: [] // Admin can add tags manually in the code for now
            });
            
            // Save and update the view
            saveDiscoverSongs();
            renderDiscoverSongs();
            renderTagFilters();
            
            // Clear input fields
            document.getElementById('discover-youtube-url').value = '';
            document.getElementById('discover-song-title').value = '';
            
            alert('Song added to Discover section!');
        }

        // Quick add to existing playlist
        function quickAdd() {
            const playlistIndex = document.getElementById('existing-playlists').value;
            if (playlistIndex === "") {
                alert('Please select a playlist');
                return;
            }
            
            document.getElementById('playlist-name').value = playlists[playlistIndex].name;
            addSong();
        }

        function logout() {
            currentUser = null;
            saveUser();
            // Redirect to login page
            window.location.href = 'index.html';
        }

        function updateUIForUser() {
            if (currentUser) {
                // User is signed in
                document.getElementById('user-email').textContent = currentUser.email;
                
                if (currentUser.isAdmin) {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                    document.getElementById('admin-controls').style.display = 'block';
                } else {
                    document.getElementById('admin-badge').style.display = 'none';
                    document.getElementById('admin-controls').style.display = 'none';
                }
                
                // Render user-specific content
                renderPlaylists();
                renderDiscoverSongs();
                renderTagFilters();
            } else {
                // User is not signed in, redirect to login
                window.location.href = 'index.html';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Application initialized');
            
            // Apply saved theme
            applyTheme(currentTheme);
            
            // Check if user is already signed in
            updateUIForUser();
            
            // Add song button event
            document.getElementById('add-song-btn').addEventListener('click', addSong);
            
            // Quick add button event
            document.getElementById('quick-add-btn').addEventListener('click', quickAdd);
            
            // Add to discover button event
            document.getElementById('add-to-discover-btn').addEventListener('click', addSongToDiscover);
            
            // Allow pressing Enter in the URL field to add a song
            document.getElementById('youtube-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addSong();
                }
            });
            
            // Logout event
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Discover button event
            document.getElementById('discover-btn').addEventListener('click', scrollToDiscover);
            
            // Theme selector events
            document.getElementById('theme-toggle-btn').addEventListener('click', toggleThemeSelector);
            
            // Theme option events
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.getAttribute('data-theme');
                    applyTheme(theme);
                    document.getElementById('theme-options').classList.remove('show');
                });
            });
            
            // Close theme selector when clicking outside
            document.addEventListener('click', function(event) {
                const themeSelector = document.querySelector('.theme-selector');
                if (!themeSelector.contains(event.target)) {
                    document.getElementById('theme-options').classList.remove('show');
                }
            });
            
            debugLog('All event listeners attached');
        });
    </script>
    
</head>
<body class="theme-original text-white min-h-screen pb-12">
    <header class="bg-black/70 py-6 mb-8 shadow-lg">
        <div class="container mx-auto px-5 flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-4xl font-bold mb-3 accent-color">
                    <i class="fas fa-music mr-2"></i> Music Manager
                </h1>
                <p class="text-xl opacity-90">Create and manage your YouTube playlists easily</p>
            </div>
            <div class="flex gap-4">
                <button id="discover-btn" class="accent-btn text-white px-6 py-3 rounded-lg cursor-pointer transition-all hover:-translate-y-1 hover:shadow-lg">
                    <i class="fas fa-compass mr-2"></i> Discover
                </button>
                <div class="theme-selector">
                    <button id="theme-toggle-btn" class="bg-white/20 text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-white/30">
                        <i class="fas fa-palette mr-2"></i> Themes
                    </button>
                    <div id="theme-options" class="theme-options">
                        <div class="theme-option" data-theme="original">
                            <span class="theme-color"></span> Original
                        </div>
                        <div class="theme-option" data-theme="red">
                            <span class="theme-color"></span> Red
                        </div>
                        <div class="theme-option" data-theme="green">
                            <span class="theme-color"></span> Green
                        </div>
                        <div class="theme-option" data-theme="purple">
                            <span class="theme-color"></span> Purple
                        </div>
                        <div class="theme-option" data-theme="black">
                            <span class="theme-color"></span> Black
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-5">
        <!-- User Info Section -->
        <div id="user-info" class="flex justify-between items-center mb-5 p-4 bg-white/10 rounded-xl">
            <div class="flex items-center gap-2.5">
                <span id="user-email"></span>
                <span id="admin-badge" class="hidden bg-orange-500 text-white px-2.5 py-1.5 rounded-full text-xs font-bold">
                    ADMIN
                </span>
            </div>
            <button id="logout-btn" 
                    class="bg-red-500 text-white border-0 px-3 py-2 rounded cursor-pointer transition-colors hover:bg-red-600">
                Logout
            </button>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <div class="flex flex-col lg:flex-row gap-8">
                <section class="flex-1 min-w-[350px] bg-white/10 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">Add New Song</h2>
                    <div class="mb-5">
                        <label for="youtube-url" class="block mb-2 font-medium">
                            <i class="fab fa-youtube mr-2"></i> YouTube URL:
                        </label>
                        <input type="text" id="youtube-url" placeholder="Paste YouTube URL here..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <div class="mb-5">
                        <label for="song-title" class="block mb-2 font-medium">
                            <i class="fas fa-heading mr-2"></i> Song Title (optional):
                        </label>
                        <input type="text" id="song-title" placeholder="Enter a custom title..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <div class="mb-5">
                        <label for="playlist-name" class="block mb-2 font-medium">
                            <i class="fas fa-list mr-2"></i> Add to Playlist:
                        </label>
                        <input type="text" id="playlist-name" placeholder="Enter playlist name..." 
                               class="w-full px-4 py-3.5 rounded-lg bg-white/90 border-0 text-base text-black">
                    </div>
                    <button id="add-song-btn" 
                            class="w-full inline-block accent-btn text-white px-6 py-3.5 rounded-lg cursor-pointer text-base font-medium text-center transition-all hover:-translate-y-1 hover:shadow-lg">
                        <i class="fas fa-plus-circle mr-2"></i> Add to Playlist
                    </button>
                    
                    <div class="quick-add-section bg-white/5 rounded-lg p-5 mt-5">
                        <h3 class="text-lg font-semibold mb-4">Quick Add to Existing Playlist</h3>
                        <div class="playlist-selector flex gap-2.5 mb-4 items-center">
                            <select id="existing-playlists" 
                                    class="flex-1 px-4 py-3 rounded-lg bg-white/90 border-0 text-black">
                                <option value="">Select a playlist...</option>
                            </select>
                            <button id="quick-add-btn" 
                                    class="accent-btn text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i> Add
                            </button>
                        </div>
                    </div>
                    
                    <div class="player-section mt-8 bg-white/10 rounded-xl p-5 shadow-lg">
                        <h3 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">
                            <i class="fas fa-play-circle mr-2"></i> Player
                        </h3>
                        <div id="player-container">
                            <div id="youtube-player" style="display: none;"></div>
                            <div id="player-placeholder" class="player-placeholder text-center p-10 bg-black/30 rounded-lg">
                                <i class="fas fa-play-circle text-5xl mb-4 opacity-50"></i>
                                <p>Select a song to play it here</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="flex-2 min-w-[350px]">
                    <h2 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">My Playlists</h2>
                    <div id="playlists-container">
                        <!-- Playlists will be generated here dynamically -->
                    </div>
                </section>
            </div>

            <!-- Discover Section -->
            <section class="discover-section bg-white/10 rounded-xl p-6 mt-8 shadow-lg">
                <h2 class="text-2xl font-bold mb-5 accent-color pb-2.5 border-b border-white/20">
                    <i class="fas fa-compass mr-2"></i> Discover
                </h2>
                
                <!-- Tag Filters -->
                <div class="tag-filters-section mb-6">
                    <h3 class="text-lg font-semibold mb-3 accent-color">Filter by Tags:</h3>
                    <div id="tag-filters" class="flex flex-wrap gap-2">
                        <!-- Tag filters will be generated here dynamically -->
                    </div>
                </div>
                
                <!-- Admin Controls (only visible to admin) -->
                <div id="admin-controls" class="admin-controls bg-orange-500/20 rounded-lg p-5 mb-5 hidden">
                    <h3 class="text-lg font-semibold mb-4 text-orange-400">Admin Controls</h3>
                    <div class="admin-form flex gap-2.5 flex-wrap">
                        <input type="text" id="discover-youtube-url" placeholder="YouTube URL for Discover section" 
                               class="flex-1 min-w-[200px] px-4 py-3 rounded-lg bg-white/90 border-0">
                        <input type="text" id="discover-song-title" placeholder="Song title" 
                               class="flex-1 min-w-[200px] px-4 py-3 rounded-lg bg-white/90 border-0">
                        <button id="add-to-discover-btn" 
                                class="bg-orange-500 text-white px-4 py-3 rounded-lg cursor-pointer transition-colors hover:bg-orange-600">
                            <i class="fas fa-plus mr-1"></i> Add to Discover
                        </button>
                    </div>
                </div>
                
                <div id="discover-songs-container" class="discover-songs grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <!-- Discover songs will be generated here dynamically -->
                </div>
            </section>
        </div>
    </div>

    <!-- YouTube API Script -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // Esta función es requerida por la API pero no necesita contenido aquí
        function onYouTubeIframeAPIReady() {
            // El reproductor se inicializará cuando se llame a playSong por primera vez
        }
    </script>

</body>
</html>
